{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
      "webAppPlanName": {
        "type": "string",
        "defaultValue": "example"
      },
      "funcAppName": {
        "type":"string",
        "defaultValue": "funcplaceholder14123"
      },
      "webAppName": {
        "type":"string",
        "defaultValue": "webplaceholder14123"
      },
      "commonAiName": {
        "type":"string",
        "defaultValue":"exampleainame"
      },
      "mySqlSrvName": {
        "type":"string",
        "defaultValue":"notusedreally2145"
      },
      "location": {
        "type": "string",
        "defaultValue": "westus"
      },
      "webAppSku": {
        "type":"object",
        "defaultvalue": {
          "name": "S1",
          "tier": "Standard",
          "size": "S1",
          "family": "S",
          "capacity": 1
        }
      },
      "appInsightsAlertEmails": {
        "type": "array",
        "defaultValue": [
          "somebody@noreplies.com",
          "somebody2@noreplies.com"
        ]
    }
    },
    "variables": {
      "mysqlAdminUsername": "supersecret",
      "mysqlAdminPassword": "3vEnm0reS3cre7!",
      "appInsightsSmartDetection": [
        "slowpageloadtime",
        "slowserverresponsetime",
        "longdependencyduration",
        "degradationinserverresponsetime",
        "degradationindependencyduration"
      ]
    },
    "resources": [
      // These resources don't produce errors, but are needed if you want to deploy the template
      // serverfarms apiVersion issue already reported at https://github.com/Azure/azure-resource-manager-schemas/issues/861
      {
        "type": "Microsoft.Web/serverfarms",
        "apiVersion": "2018-11-01",
        "name": "[parameters('webAppPlanName')]",
        "location": "[parameters('location')]",
        "sku": "[parameters('webAppSku')]",
        "properties": {
          "name": "[parameters('webAppPlanName')]"
        }
      },
      {
        "type": "Microsoft.Web/sites",
        "apiVersion": "2018-11-01",
        "name": "[parameters('webAppName')]",
        "location": "[parameters('location')]",
        "properties": {
          "name": "[parameters('webAppName')]",
          "serverFarmId": "[resourceId('Microsoft.Web/serverfarms/', parameters('webAppPlanName'))]"
        },
        "identity": {
          "type": "SystemAssigned"
        },
        "resources": [
        ],
        "dependsOn": [
          "[parameters('webAppPlanName')]"
        ]
      },
      {
        "apiVersion": "2018-11-01",
        "type": "Microsoft.Web/sites",
        "name": "[parameters('funcAppName')]",
        "location": "[parameters('location')]",
        "kind": "functionapp",
        "identity": {
          "type": "SystemAssigned"
        },
        "properties": {
          "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', parameters('webAppPlanName'))]",
          "httpsOnly": true
        },
        "resources": [],
        "dependsOn": [
          "[parameters('webAppPlanName')]"
        ]
      },
      {
        "apiVersion": "2015-05-01",
        "type": "Microsoft.Insights/components",
        "kind": "web",
        "name": "[parameters('commonAIName')]",
        "location": "[parameters('location')]",
        "scale": null,
        "properties": {
          "Application_Type": "web",
          "Flow_Type": "Bluefield",
          "Request_Source": "rest"
        }
      },
      {
        "type": "Microsoft.Insights/webtests",
        "name": "[parameters('funcAppName')]",
        "dependsOn": [
          "[parameters('commonAIName')]"
        ],
        "apiVersion": "2015-05-01",
        "location": "[parameters('location')]",
        "tags": {
          "[concat('hidden-link:', resourceGroup().id, '/providers/microsoft.insights/components/', parameters('commonAIName'))]": "Resource",
          "[concat('hidden-link:', resourceGroup().id, '/providers/Microsoft.Web/sites/', parameters('funcAppName'))]": "Resource"
        },
        "kind": "ping",
        "properties": {
          "SyntheticMonitorId": "[parameters('funcAppName')]",
          "Name": "[parameters('funcAppName')]",
          "Description": "WebApp ping availability",
          "Enabled": true,
          "Frequency": 300,
          "Timeout": 120,
          "Kind": "ping",
          "RetryEnabled": true,
          "Locations": [
            {
              "Id": "us-ca-sjc-azr"
            },
            {
              "Id": "us-tx-sn1-azr"
            },
            {
              "Id": "us-il-ch1-azr"
            },
            {
              "Id": "emea-gb-db3-azr"
            },
            {
              "Id": "us-va-ash-azr"
            },
            {
              "Id": "us-fl-mia-edge"
            }
          ],
          "Configuration": {
            "WebTest": "[concat('<WebTest         Name=\"', parameters('funcAppName') , '\"         Id=\"', guid(parameters('funcAppName')) ,'\"         Enabled=\"True\"         CssProjectStructure=\"\"         CssIteration=\"\"         Timeout=\"0\"         WorkItemIds=\"\"         xmlns=\"http://microsoft.com/schemas/VisualStudio/TeamTest/2010\"         Description=\"\"         CredentialUserName=\"\"         CredentialPassword=\"\"         PreAuthenticate=\"True\"         Proxy=\"default\"         StopOnError=\"False\"         RecordedResultFile=\"\"         ResultsLocale=\"\">        <Items>        <Request         Method=\"GET\"         Guid=\"eb6c68ca-0c20-4a87-9a9d-903111d9fb1a\"         Version=\"1.1\"        Url=\"', 'https://', parameters('funcAppName'), '.azurewebsites.net/api/server/ping?api-version=2019-01-09' , '\"         ThinkTime=\"0\"         Timeout=\"300\"         ParseDependentRequests=\"True\"         FollowRedirects=\"True\"         RecordResult=\"True\"         Cache=\"False\"         ResponseTimeGoal=\"0\"         Encoding=\"utf-8\"         ExpectedHttpStatusCode=\"200\"         ExpectedResponseUrl=\"\"         ReportingName=\"\"         IgnoreHttpStatusCode=\"False\" />        </Items>        </WebTest>')]"
          }
        }
      },
      {
        "type": "Microsoft.Insights/actionGroups",
        "name": "Zure Monitor",
        "apiVersion": "2018-03-01",
        "location": "Global",
        "properties": {
          "groupShortName": "ZMonitor",
          "enabled": true
        }
      },


      // All the resources below have some "oneOf" & other issues with VS code extension version 0.84
      {
        "name": "[concat('App Service Plan - High CPU - ', parameters('webAppPlanName'))]",
        "type": "Microsoft.Insights/metricAlerts",
        "location": "global",
        "apiVersion": "2018-03-01",
        "dependsOn": [
          "[resourceId('Microsoft.Web/serverfarms', parameters('webAppPlanName'))]",
          "[resourceId('microsoft.insights/actionGroups', 'Zure Monitor')]"
        ],
        "tags": {
          "[concat('hidden-link:', resourceId('Microsoft.Web/serverfarms', parameters('webAppPlanName')))]": "Resource",
          "displayName": "[concat('App Service Plan - High CPU - ', parameters('webAppPlanName'))]"
        },
        "properties": {
          "description": "[concat(parameters('webAppPlanName'), ' has high cpu usage.')]",
          "enabled": true,
          "scopes": [
            "[resourceId('Microsoft.Web/serverfarms', parameters('webAppPlanName'))]"
          ],
          "severity": 1,
          "evaluationFrequency": "PT1M",
          "windowSize": "PT5M",
          "criteria": {
            "odata.type": "Microsoft.Azure.Monitor.SingleResourceMultipleMetricCriteria",
            "allOf": [
              {
                "name": "1st criterion",
                "metricName": "CpuPercentage",
                "dimensions": [
                ],
                "operator": "GreaterThan",
                "threshold": 90,
                "timeAggregation": "Average"
              }
            ]
          },
          "actions": [
            {
              "actionGroupId": "[resourceId('microsoft.insights/actionGroups', 'Zure Monitor')]"
            }
          ]
        }
      },
      {
        "type": "Microsoft.Insights/metricAlerts",
        "name": "[concat('App Service - Availability - ', parameters('funcAppName'))]",
        "apiVersion": "2018-03-01",
        "location": "global",
        "tags": {
          "[concat('hidden-link:', resourceGroup().id, '/providers/microsoft.insights/components/', parameters('commonAIName'))]": "Resource",
          "[concat('hidden-link:', resourceGroup().id, '/providers/microsoft.insights/webtests/', parameters('funcAppName'))]": "Resource"
        },
        "properties": {
          "description": "Function App Availability test",
          "severity": 1,
          "enabled": true,
          "evaluationFrequency": "PT1M",
          "windowSize": "PT5M",
          "criteria": {
            "odata.type": "Microsoft.Azure.Monitor.WebtestLocationAvailabilityCriteria",
            "componentId": "[resourceId('Microsoft.Insights/components', parameters('commonAIName'))]",
            "failedLocationCount": 1,
            "webTestId": "[resourceId('Microsoft.Insights/webtests', parameters('funcAppName'))]"
          },
          "scopes": [
            "[resourceId('Microsoft.Insights/webtests', parameters('funcAppName'))]",
            "[resourceId('microsoft.insights/components', parameters('commonAIName'))]"
          ],
          "actions": [
            {
              "actionGroupId": "[resourceId('microsoft.insights/actionGroups', 'Zure Monitor')]"
            }
          ]
        },
        "dependsOn": [
          "[resourceId('microsoft.insights/webtests/', parameters('funcAppName'))]"
        ]
      },
      {
        "name": "[concat('App Service - Server Errors - ', parameters('webAppName'))]",
        "type": "Microsoft.Insights/metricAlerts",
        "location": "global",
        "apiVersion": "2018-03-01",
        "dependsOn": [
          "[resourceId('Microsoft.Web/sites', parameters('webAppName'))]",
          "[resourceId('microsoft.insights/actionGroups', 'Zure Monitor')]"
        ],
        "tags": {
          "[concat('hidden-link:', resourceId('Microsoft.Web/sites', parameters('webAppName')))]": "Resource",
          "displayName": "[concat('App Service - Server Errors - ', parameters('webAppName'))]"
        },
        "properties": {
          "description": "[concat(parameters('webAppName'), ' has some server errors, status code 5xx.')]",
          "enabled": true,
          "scopes": [
            "[resourceId('Microsoft.Web/sites', parameters('webAppName'))]"
          ],
          "severity": 1,
          "evaluationFrequency": "PT1M",
          "windowSize": "PT5M",
          "criteria": {
            "odata.type": "Microsoft.Azure.Monitor.SingleResourceMultipleMetricCriteria",
            "allOf": [
              {
                "name": "1st criterion",
                "metricName": "Http5xx",
                "dimensions": [
                ],
                "operator": "GreaterThan",
                "threshold": 0,
                "timeAggregation": "Count"
              }
            ]
          },
          "actions": [
            {
              "actionGroupId": "[resourceId('microsoft.insights/actionGroups', 'Zure Monitor')]"
            }
          ]
        }
      },
      {
        "type": "Microsoft.DBforMySQL/servers",
        "apiVersion": "2017-12-01-preview",
        "name": "[parameters('mySQLSrvName')]",
        "location": "[parameters('location')]",
        "sku": {
          "name": "B_Gen5_2",
          "tier": "Basic",
          "capacity":  2,
          "size": 51200,
          "family": "Gen5"
        },
        "properties": {
          "version": "5.6",
          "administratorLogin": "[variables('mysqlAdminUsername')]",
          "administratorLoginPassword": "[variables('mySqlAdminPassword')]",
          "storageProfile": {
            "storageMB": 51200,
            "backupRetentionDays": 35,
            "geoRedundantBackup": "Disabled",
            "storageAutoGrow": "Enabled"
          }
        },
        "resources": [
          {
            "type": "configurations",
            "name": "max_allowed_packet",
            "apiVersion": "2017-12-01",
            "location": "westeurope",
            "properties": {
              "value": "536870912",
              "source": "user-override"
            },
            "dependsOn": [
              "[parameters('mysqlSrvName')]"
            ]
          }
        ]
      },
      {
        "copy": {
          "name": "smartdetectioncopy1",
          "count": "[length(variables('appInsightsSmartDetection'))]",
          "mode": "parallel"
        },
        "name": "[concat(parameters('commonAiName'),'/',variables('appInsightsSmartDetection')[copyIndex()])]",
        "type": "Microsoft.Insights/components/ProactiveDetectionConfigs",
        "apiVersion": "2018-05-01-preview",
        "location": "[parameters('location')]",
        "dependsOn": [
          "[resourceId('Microsoft.Insights/components', parameters('commonAiName'))]"
        ],
        "properties": {
          "enabled": true,
          "sendEmailsToSubscriptionOwners": false,
          "customEmails": "[parameters('appInsightsAlertEmails')]",
          "name": "[variables('appInsightsSmartDetection')[copyIndex()]]"
        }
      }
    ],
    "outputs": {},
    "functions": []
}